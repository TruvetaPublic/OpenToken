# OpenToken Metadata Format Documentation

## Overview

OpenToken generates metadata files alongside the output files to provide information about the processed data. These metadata files contain statistical information about the processed records like the invalid attributes, number of records processed, blank tokens generated by rule, system/runtime information, and secure hashes of the keys/public keys involved.

## Metadata Format

The metadata is stored in JSON format with the extension `.metadata.json` and contains key-value pairs representing various aspects of the processing.

## Metadata Fields

- `JavaVersion` / `PythonVersion`: The version of Java or Python used to run the processing (field name depends on platform)
- `OpenTokenVersion`: The version of the OpenToken library
- `Platform`: The platform/environment used for processing (e.g., "Java" or "Python")
- `TotalRows`: The total number of records processed
- `TotalRowsWithInvalidAttributes`: The number of records that contained one or more invalid attributes
- `InvalidAttributesByType`: A breakdown of invalid attributes by type, showing the count for each attribute type
- `BlankTokensByRule`: A breakdown of blank tokens generated by rule/token identifier, showing the count for each rule
- `HashingSecretHash`: Optional SHA-256 hash (hex) of the hashing key material used
- `EncryptionSecretHash`: Optional SHA-256 hash (hex) of the encryption key material used
- `KeyExchangeMethod`: Key exchange method identifier (e.g., `ECDH-P-384`)
- `Curve`: Elliptic curve name used for ECDH (e.g., `P-384`)
- `SenderPublicKeyHash`: SHA-256 hash (hex) of the sender public key bytes
- `ReceiverPublicKeyHash`: SHA-256 hash (hex) of the receiver public key bytes

## Key Exchange

OpenToken derives symmetric keys from sender/receiver public keys using ECDH + HKDF.

The metadata file stores SHA-256 hashes to allow verification of which keys were used without exposing them.

Hashes are calculated as:

```text
SHA-256(value) -> hex-encoded string
```

OpenToken records hashes of the public keys involved (`SenderPublicKeyHash`, `ReceiverPublicKeyHash`) and the selected curve/method (`Curve`, `KeyExchangeMethod`).

`HashingSecretHash` and `EncryptionSecretHash` are optional and may not be present for ECDH runs; the public-key hashes are the primary audit identifiers.

## Hash Calculator Tool

A Python tool is provided to independently calculate SHA-256 hashes used in the metadata file (for example, public key hashes). This tool can be used to verify that the correct keys were used or to calculate hashes for comparison purposes.

The tool is located at `tools/hash_calculator.py` and can be used as follows:

```bash
# Calculate hash for a sender public key (matches SenderPublicKeyHash)
python tools/hash_calculator.py --sender-public-key path/to/public_key.pem

# Calculate hash for a receiver public key (matches ReceiverPublicKeyHash)
python tools/hash_calculator.py --receiver-public-key path/to/public_key.pem
```

The tool outputs the calculated hashes in the same format as stored in the metadata file, making it easy to verify that the correct keys were used.

## Example

ECDH example:

```json
{
  "Platform": "Python",
  "PythonVersion": "3.12.0",
  "OpenTokenVersion": "1.7.0",
  "TotalRows": "101",
  "TotalRowsWithInvalidAttributes": "9",
  "InvalidAttributesByType": {
    "BirthDate": 3
  },
  "BlankTokensByRule": {
    "T1": 5
  },
  "KeyExchangeMethod": "ECDH-P-384",
  "Curve": "P-384",
  "SenderPublicKeyHash": "...",
  "ReceiverPublicKeyHash": "..."
}
```
